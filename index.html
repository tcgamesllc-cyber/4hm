<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4HM Jank-O-Meter</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
  <style>
    body { font-family: 'Book Antiqua', Palatino, serif; background: #fdf6e3; color: #2b1a08; margin:0; padding:0; }
    header { background: #f2e6c6; padding: 20px; text-align:center; border-bottom: 2px solid #d6b87a; }
    header h1 { margin:0; font-size:28px; }
    .wrap { max-width: 1100px; margin: 20px auto; padding: 0 12px; }
    .panel { background:#fff9e6; border:1px solid #d6b87a; border-radius:12px; padding:16px; margin-bottom:16px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; background:#f2e6c6; border-radius:999px; }
    input[type="range"] { width: 240px; }
    #thresholdNumber { width:80px; }
    .btn { background:#fdf6e3; border:1px solid #c8a96c; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .btn-mini { font-size:13px; padding:4px 6px; }
    .table-wrap { overflow-x:auto; }
    table.dataTable { border:1px solid #d6b87a; }
    table.dataTable thead th { background:#f2e6c6; }
  </style>
</head>
<body>
  <header>
    <h1>⚡ 4HM Jank-O-Meter ⚡</h1>
    <div>Slide to set a maximum <b>Total Appearances</b>. Cards at or below are tagged as <i>Jank</i>.</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="pill">
        Threshold ≤ <span id="thresholdLabel">…</span>
        <input id="threshold" type="range" min="0" max="100" value="5" step="1"/>
        <input id="thresholdNumber" type="number" min="0" value="5" step="1"/>
      </div>
      <div class="pill" id="quickPresets">
        Quick:
        <button class="btn btn-mini" data-th="1">≤1</button>
        <button class="btn btn-mini" data-th="2">≤2</button>
        <button class="btn btn-mini" data-th="3">≤3</button>
        <button class="btn btn-mini" data-th="4">≤4</button>
        <button class="btn btn-mini" data-th="8">≤8</button>
      </div>
      <div class="pill">
        <label for="setFilter">Filter by Set:</label>
        <select id="setFilter"><option value="">All</option></select>
      </div>
      <button id="exportBtn" class="btn">Export CSV</button>
      <button id="copyLinkBtn" class="btn">Copy Link</button>
      <div id="meta"></div>
    </div>

    <div class="panel table-wrap">
      <table id="jankTable" class="display" style="width:100%">
        <thead><tr><th>Set</th><th>Card</th><th>Main</th><th>Side</th><th>Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8EjG79BHZiJz5qpnb8cMTN3R_3j_pbKlNODR3iggZhSF9VaKjjWNRle6DVkqGMBOlo0YyoTbW7vjX/pub?gid=0&single=true&output=csv";
let allRows=[], dataTable=null, MAX_TOTAL=0;
const params=new URLSearchParams(location.search);

function sliderToThreshold(s){ const k=Math.log(MAX_TOTAL+1)/100; return Math.round(Math.exp(k*s)-1); }
function thresholdToSlider(t){ const k=Math.log(MAX_TOTAL+1)/100; return Math.round(Math.log(t+1)/k); }

window.addEventListener('DOMContentLoaded',()=>{
  Papa.parse(CSV_URL,{download:true,header:true,skipEmptyLines:true,complete:onCSV});
});

function onCSV(res){
  allRows=res.data.filter(r=>r["Card Name"]).map(r=>({set:r["Set Name"],card:r["Card Name"],main:+r["Main Deck"]||0,side:+r["Sideboard"]||0,total:+r["Total"]||0}));
  MAX_TOTAL=allRows.reduce((m,r)=>Math.max(m,r.total),0);
  const init=params.get('max')?+params.get('max'):4;
  initUI(init);
  populateSetFilter();
  renderTable(init, params.get('set'));
  document.getElementById('meta').textContent=`Loaded ${allRows.length} rows. Max=${MAX_TOTAL}`;
}

function initUI(initial){
  const slider=document.getElementById('threshold');
  const box=document.getElementById('thresholdNumber');
  const label=document.getElementById('thresholdLabel');
  slider.value=thresholdToSlider(initial); box.value=initial; label.textContent=initial;

  slider.addEventListener('input',e=>sync(sliderToThreshold(+e.target.value)));
  box.addEventListener('input',e=>sync(+e.target.value));

  document.querySelectorAll('#quickPresets .btn-mini').forEach(b=>b.addEventListener('click',()=>sync(+b.dataset.th)));
  document.getElementById('setFilter').addEventListener('change',()=>sync(+box.value));
  document.getElementById('exportBtn').addEventListener('click',exportCSV);
  document.getElementById('copyLinkBtn').addEventListener('click',copySharableLink);

  function sync(val){
    val=Math.max(0,Math.min(val,MAX_TOTAL));
    slider.value=thresholdToSlider(val); box.value=val; label.textContent=val;
    renderTable(val, document.getElementById('setFilter').value||"");
    updateQuery(val, document.getElementById('setFilter').value||"");
  }
}

function populateSetFilter(){
  const sel=document.getElementById('setFilter');
  [...new Set(allRows.map(r=>r.set))].sort().forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});
  if(params.get('set')) sel.value=params.get('set');
}

function renderTable(threshold,setFilter){
  const rows=allRows.filter(r=>r.total<=threshold && (!setFilter||r.set===setFilter));
  const data=rows.map(r=>[r.set,r.card,r.main,r.side,r.total]);
  if(dataTable){dataTable.clear().rows.add(data).draw();return;}
  dataTable=$('#jankTable').DataTable({data,columns:[{title:'Set'},{title:'Card'},{title:'Main'},{title:'Side'},{title:'Total'}],order:[[4,'asc']],pageLength:25});
}

function exportCSV(){
  const v=+document.getElementById('thresholdNumber').value;
  const set=document.getElementById('setFilter').value||'';
  const rows=allRows.filter(r=>r.total<=v && (!set||r.set===set));
  const csv=[['Set','Card','Main','Side','Total']].concat(rows.map(r=>[r.set,r.card,r.main,r.side,r.total])).map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`jank-${v}.csv`;a.click();
}

function updateQuery(max,set){
  const url=new URL(location.href);
  url.searchParams.set('max',max);
  if(set) url.searchParams.set('set',set); else url.searchParams.delete('set');
  history.replaceState(null,'',url);
}

async function copySharableLink(){
  try{await navigator.clipboard.writeText(location.href);alert('Link copied!');}catch(e){alert('Copy failed');}
}
</script>
</body>
</html>
