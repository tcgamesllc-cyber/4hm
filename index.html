<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4HM Jank-O-Meter</title>

  <!-- Data & table libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <style>
    :root { --bg:#fdf6e3; --card:#f9f2dd; --ink:#2b1a08; --muted:#7c6a4c; }

    html, body {
      margin:0; padding:0;
      background:#fdf6e3;
      color:var(--ink);
      font:16px/1.5 "Book Antiqua", Palatino, serif;
      background-image: radial-gradient(circle at top left, #fff9e6, #fdf6e3 60%, #f3e4c1);
      border:40px solid transparent;
      /* parchment scroll border texture (public HTTPS image) */
      border-image: url('https://i.imgur.com/vK5wZyH.png') 100 repeat;
      min-height:100vh;
      box-sizing:border-box;
    }

    /* Watermark logo (faint 4HM logo in the background) */
    body::after {
      content:"";
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%, -50%);
      width:600px; height:600px;
      background:url('https://i.imgur.com/Vl8m6rM.png') no-repeat center/contain; /* placeholder 4HM logo */
      opacity:0.07;
      pointer-events:none;
      z-index:0;
    }

    /* Header parchment scroll */
    header {
      background:#fdf6e3;
      background-image: radial-gradient(circle at top left, #fff9e6, #fdf6e3 60%, #f3e4c1);
      border-bottom:4px solid #d6b87a;
      border-top:4px solid #d6b87a;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
      padding:24px 16px;
      text-align:center;
      font-family:"Book Antiqua", Palatino, serif;
      position:relative;
      z-index:1;
    }
    header h1 {
      margin:0;
      font-size:32px;
      color:#3a240a;
      text-shadow:1px 1px 0 #fff;
    }
    header .sub {
      margin-top:6px;
      font-size:15px;
      color:#5a3816;
    }

    .wrap { max-width:1100px; margin:20px auto 60px; padding:0 16px; position:relative; z-index:1; }
    .panel { background:var(--card); border-radius:16px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.25); }
    .controls { display:grid; gap:12px; grid-template-columns: 1fr; align-items:center; }
    .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .pill {
      background:#f2e6c6; border:1px solid #c8a96c; color:var(--ink);
      padding:8px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:10px;
    }

    /* Brass slider (CROSS-BROWSER) */
    input[type="range"] {
      -webkit-appearance: none !important;
      appearance: none !important;
      width: 260px;
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(to right, #d6b87a, #b38b4d);
      outline: none;
      margin: 0 8px;
      cursor: pointer;
      border: 1px solid #8b5a2b;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.4);
    }
    /* Chrome/Safari/Edge */
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none !important;
      appearance: none !important;
      width: 20px; height: 20px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b);
      border: 2px solid #5c3b16;
      box-shadow: inset 0 0 6px #d6b87a, 0 0 2px #000;
      cursor: pointer;
      transition: transform .05s ease-in-out;
    }
    input[type="range"]:active::-webkit-slider-thumb { transform: scale(1.05); }
    /* Firefox */
    input[type="range"]::-moz-range-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b);
      border: 2px solid #5c3b16;
      box-shadow: inset 0 0 6px #d6b87a, 0 0 2px #000;
      cursor: pointer;
      transition: transform .05s ease-in-out;
    }
    input[type="range"]:active::-moz-range-thumb { transform: scale(1.05); }
    /* IE/Edge legacy */
    input[type="range"]::-ms-thumb {
      width: 20px; height: 20px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b);
      border: 2px solid #5c3b16;
      box-shadow: inset 0 0 6px #d6b87a, 0 0 2px #000;
      cursor: pointer;
    }

    /* Matching number input */
    #thresholdNumber {
      width: 90px;
      background: #fff9e6;
      color: #2b1a08;
      border: 2px solid #c8a96c;
      border-radius: 8px;
      padding: 6px 8px;
      font-family: 'Book Antiqua', Palatino, serif;
      box-shadow: inset 0 0 5px #d6b87a;
    }

    .muted { color:var(--muted); font-size:13px; }
    .kpi { font-weight:700; color:#8b4513; }
    .actions { margin-left:auto; display:flex; gap:10px; }
    .btn {
      background:#fdf6e3; border:1px solid #c8a96c; color:#3a240a;
      padding:8px 12px; border-radius:10px; cursor:pointer;
      font-family:"Book Antiqua", Palatino, serif;
    }
    .btn:hover { background:#f8edd4; }

    /* Table parchment skin */
    table.dataTable {
      background:#fdf6e3;
      border:2px solid #d6b87a;
      border-radius:12px;
      overflow:hidden;
    }
    table.dataTable thead th {
      background:#f2e6c6;
      color:#3a240a;
      font-weight:bold;
      border-bottom:2px solid #d6b87a;
    }
    table.dataTable tbody tr:nth-child(even) { background:#fbf2de; }
    table.dataTable tbody tr:nth-child(odd)  { background:#f6ebd2; }
    table.dataTable tbody td { color:#2b1a08; }
    a, a:visited { color:#7a3e00; }

    /* About box parchment */
    #about {
      margin-top:20px; font-size:14px; line-height:1.5; color:#2b1a08;
      background:#fdf6e3; border:2px solid #d6b87a; border-radius:12px; padding:16px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.25), 0 4px 12px rgba(0,0,0,0.25);
      background-image: radial-gradient(circle at top left, #fff9e6, #fdf6e3 60%, #f3e4c1);
    }
    #about b { color:#3a240a; }
    #about a { color:#7a3e00; font-weight:600; }
    #about a:hover { color:#a75500; }
  </style>
</head>
<body>
  <header>
    <h1>‚ö° 4HM Jank-O-Meter ‚ö°</h1>
    <div class="sub">Slide to set a maximum <b>Total Appearances</b>. Cards at or below the threshold are tagged as <i>Jank</i> (rarely used).</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="controls">
        <div class="row">
          <div class="pill" title="Set the maximum total appearances to include">
            <span>Threshold ‚â§ <span id="thresholdLabel" class="kpi">‚Ä¶</span></span>
            <input id="threshold" type="range" min="0" max="100" value="50" step="1"/>
            <input id="thresholdNumber" type="number" min="0" max="100" value="50" step="1" title="Type an exact threshold"/>
          </div>
          <div class="pill" title="Filter results by set">
            <label for="setFilter" class="muted">Filter by Set:</label>
            <select id="setFilter" style="background:#fff9e6; color:#2b1a08; border:1px solid #c8a96c; border-radius:8px; padding:6px 8px;">
              <option value="">All Sets</option>
            </select>
          </div>
          <div class="actions">
            <button id="exportBtn" class="btn" title="Download the current jank list as CSV">Export CSV</button>
            <button id="copyLinkBtn" class="btn" title="Copy a sharable link with your current settings">Copy Sharable Link</button>
          </div>
        </div>
        <div class="muted" id="meta">Loading data‚Ä¶</div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px;">
      <table id="jankTable" class="display" style="width:100%">
        <thead>
          <tr>
            <th>Set Name</th>
            <th>Card Name</th>
            <th>Main Deck</th>
            <th>Sideboard</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="about">
        <p><b>About Jank-O-Meter:</b> This tool defines <i>Jank</i> as any legal 4HM card that has appeared in tournament decks fewer times than the chosen threshold. Adjust the slider to reveal the deepest jank of the format.</p>
        <p>üìä <b>Data Source:</b> <a href="https://docs.google.com/spreadsheets/d/1hrPpYnM7QcIL8IEz03ZZn0cUiRIAtAaBIRk1g6ru-1s/edit?usp=sharing" target="_blank" rel="noopener">4HM Tournament Card Usage Sheet</a> (Google Sheets, live CSV).</p>
        <p id="lastUpdated">‚è±Ô∏è <b>Last updated:</b> ‚Ä¶</p>
      </div>
    </div>
  </div>

  <script>
    // Live CSV published from Google Sheets
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8EjG79BHZiJz5qpnb8cMTN3R_3j_pbKlNODR3iggZhSF9VaKjjWNRle6DVkqGMBOlo0YyoTbW7vjX/pub?gid=0&single=true&output=csv";

    let allRows = [];
    let dataTable = null;

    // read query params (for sharable links)
    const params = new URLSearchParams(location.search);
    const qThreshold = params.get('max');
    const qSet = params.get('set');

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      complete: (res) => {
        allRows = res.data
          .filter(r => r && r["Card Name"])
          .map(r => ({
            set: String(r["Set Name"]).trim(),
            card: String(r["Card Name"]).trim(),
            main: Number(r["Main Deck"]) || 0,
            side: Number(r["Sideboard"]) || 0,
            total: Number(r["Total"]) || 0,
          }));

        const maxTotal = allRows.reduce((m, r) => Math.max(m, r.total), 0);
        const initial = clampNumber(qThreshold ? Number(qThreshold) : Math.min(50, maxTotal), 0, maxTotal);

        initUI(maxTotal, initial);
        populateSetFilter(allRows.map(r => r.set));
        renderTable(initial, qSet);

        const uniques = new Set(allRows.map(r => `${r.set}||${r.card}`)).size;
        document.getElementById('meta').textContent =
          `Loaded ${allRows.length.toLocaleString()} rows (${uniques.toLocaleString()} unique cards). Max Total = ${maxTotal.toLocaleString()}.`;
        document.getElementById('lastUpdated').innerHTML =
          `‚è±Ô∏è <b>Last updated:</b> ${new Date().toLocaleString()}`;
      },
      error: (err) => {
        document.getElementById('meta').textContent = `Error loading CSV: ${err}`;
      }
    });

    function clampNumber(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function initUI(maxTotal, initial){
      const slider = document.getElementById('threshold');
      const box = document.getElementById('thresholdNumber');
      const label = document.getElementById('thresholdLabel');
      slider.max = String(maxTotal);
      box.max = String(maxTotal);
      slider.value = String(initial);
      box.value = String(initial);
      label.textContent = initial.toLocaleString();

      const sync = (val) => {
        const v = clampNumber(Number(val)||0, 0, Number(slider.max));
        slider.value = String(v);
        box.value = String(v);
        label.textContent = v.toLocaleString();
        renderTable(v, document.getElementById('setFilter').value || "");
        updateQuery(v, document.getElementById('setFilter').value || "");
      };

      slider.addEventListener('input', e => sync(e.target.value));
      box.addEventListener('input',   e => sync(e.target.value));

      document.getElementById('setFilter').addEventListener('change', () => {
        const v = Number(slider.value);
        renderTable(v, document.getElementById('setFilter').value || "");
        updateQuery(v, document.getElementById('setFilter').value || "");
      });

      document.getElementById('exportBtn').addEventListener('click', exportCSV);
      document.getElementById('copyLinkBtn').addEventListener('click', copySharableLink);
    }

    function populateSetFilter(sets){
      const sel = document.getElementById('setFilter');
      const uniq = Array.from(new Set(sets)).sort((a,b)=>a.localeCompare(b));
      uniq.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s; sel.appendChild(opt);
      });
      if (params.get('set')) sel.value = params.get('set');
    }

    function renderTable(threshold, setFilter){
      const rows = allRows.filter(r => r.total <= threshold && (!setFilter || r.set === setFilter));
      const data = rows.map(r => [r.set, r.card, r.main, r.side, r.total]);

      if (dataTable){ dataTable.clear().rows.add(data).draw(); return; }

      dataTable = $('#jankTable').DataTable({
        data,
        columns: [
          { title: 'Set Name' },
          { title: 'Card Name' },
          { title: 'Main Deck' },
          { title: 'Sideboard' },
          { title: 'Total' }
        ],
        order: [[4, 'asc'], [0, 'asc'], [1, 'asc']],
        pageLength: 25,
        deferRender: true,
        dom: 'tip' // table + info + pagination
      });
    }

    function exportCSV(){
      const v = Number(document.getElementById('threshold').value);
      const set = document.getElementById('setFilter').value || '';
      const rows = allRows.filter(r => r.total <= v && (!set || r.set === set));
      const header = ['Set Name','Card Name','Main Deck','Sideboard','Total'];
      const lines = [header.join(',')].concat(rows.map(r => [r.set, r.card, r.main, r.side, r.total].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `4HM-jank-threshold-${v}${set?`-${set.replace(/\s+/g,'_')}`:''}.csv`;
      a.click();
    }

    function updateQuery(max, set){
      const url = new URL(location.href);
      if (max != null) url.searchParams.set('max', String(max));
      if (set) url.searchParams.set('set', set); else url.searchParams.delete('set');
      history.replaceState(null, '', url);
    }

    async function copySharableLink(){
      try {
        await navigator.clipboard.writeText(location.href);
        alert('Sharable link copied to clipboard!');
      } catch(e){
        alert('Copy failed. You can manually copy the URL from the address bar.');
      }
    }
  </script>
</body>
</html>
